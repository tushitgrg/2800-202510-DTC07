const { processFile } = require("../utils/fileHandler");
const { getGeminiOutput } = require("../utils/geminiClient");
const { createQuiz, getQuiz, deleteQuiz } = require("./quizController");
const addQuizEntry = require("../utils/addQuizEntry");

const Resource = require("../models/resourceModel");

const getResources = async function (req, res) {
  const { quizPrompt, flashcardPrompt, summaryPrompt } = req.body;
};
const getResourceById = async function (req, res) {
  const { quizPrompt, flashcardPrompt, summaryPrompt } = req.body;
};


//POST request handler for creating a resource
const addResource = async function (req, res) {
  const { quizPrompt, flashcardPrompt, summaryPrompt } = req.body;
  if (!req.file) {
    return res.status(400).json({ error: "No file uploaded" });
  }

  const file = await processFile(req.file);

  if (!file) {
    return res.status(500).json({ error: "Failed to process file" });
  }
  const newResource = Resource.create({
    quizID: null,
    flashcardID: null,
    summaryID: null,
  });

  if (quizPrompt) {
    try {
      const quiz = await getGeminiOutput(file, quizPrompt);
      const quizId = await addQuizEntry(quiz);
      await Resource.findByIdAndUpdate(newResource._id, { quizID: quizId });
    } catch (err) {
      res.status(500).error("Failed to create quiz: ", err);
    }
  }

  if (flashcardPrompt) {
    try {
      const flashcard = await getGeminiOutput(file, flashcardPrompt);
      const flashcardId = await addFlashcardEntry(flashcard);
      await Resource.findByIdAndUpdate(newResource._id, {
        flashcardID: flashcardId,
      });
    } catch (err) {
      res.status(500).error("Failed to create flashcard: ", err);
    }
  }

  if (summaryPrompt) {
    try {
      const summary = await getGeminiOutput(file, summaryPrompt);
      const summaryId = await addSummaryEntry(summary);
      await Resource.findByIdAndUpdate(newResource._id, {
        summaryID: summaryId,
      });
    } catch (err) {
      res.status(500).error("Failed to create summary: ", err);
    }
  }
};

module.exports = { getResources, getResourceById, addResource };
